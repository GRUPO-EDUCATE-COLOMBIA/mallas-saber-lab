<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Mallas de Aprendizaje</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="container mt-5">
        <div class="card shadow-lg p-4">
            <h2 class="text-center mb-4 text-primary">Consulta de Mallas de Aprendizaje</h2>
            
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="area" class="form-label">Área:</label>
                    <select id="area" class="form-select">
                        <option value="" disabled selected>Seleccione un área</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="grado" class="form-label">Grado:</label>
                    <select id="grado" class="form-select" disabled>
                        <option value="" disabled selected>Seleccione un grado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="componente" class="form-label">Componente:</label>
                    <select id="componente" class="form-select" disabled>
                        <option value="" disabled selected>Seleccione un componente</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="competencia" class="form-label">Competencia:</label>
                    <select id="competencia" class="form-select" disabled>
                        <option value="" disabled selected>Seleccione una competencia</option>
                    </select>
                </div>
            </div>

            <div class="text-center mt-4">
                <button id="consultar" class="btn btn-primary btn-lg w-100">Consultar</button>
            </div>
        </div>

        <!-- Marco de Resultados -->
        <div id="resultados" class="mt-5 d-none">
            <div class="card shadow-sm p-4">
                <h3 class="text-secondary mb-3">Resultados de la Consulta</h3>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Aprendizaje</th>
                                <th>Evidencia</th>
                                <th>Estándar</th>
                                <th>DBA</th>
                            </tr>
                        </thead>
                        <tbody id="resultado-cuerpo">
                            <!-- Los resultados se insertarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Lógica de Consulta -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const areaSelect = document.getElementById('area');
            const gradoSelect = document.getElementById('grado');
            const componenteSelect = document.getElementById('componente');
            const competenciaSelect = document.getElementById('competencia');
            const btnConsultar = document.getElementById('consultar');
            const resultadoCuerpo = document.getElementById('resultado-cuerpo');
            const resultadosDiv = document.getElementById('resultados');

            let mallasData = [];

            // 1. Cargar el JSON desde la ruta correcta
            fetch('json/mallas.json')
                .then(response => {
                    if (!response.ok) throw new Error("Error al cargar el archivo JSON");
                    return response.json();
                })
                .then(data => {
                    mallasData = data;
                    poblarAreas();
                })
                .catch(error => console.error("Error:", error));

            function poblarAreas() {
                const areas = [...new Set(mallasData.map(item => item.area))];
                areas.sort().forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
            }

            // 2. Al cambiar Área -> Filtra Grados
            areaSelect.addEventListener('change', () => {
                const areaSel = areaSelect.value;
                const grados = [...new Set(mallasData
                    .filter(item => item.area === areaSel)
                    .map(item => item.grado))];

                gradoSelect.innerHTML = '<option value="" disabled selected>Seleccione un grado</option>';
                grados.sort((a, b) => a - b).forEach(grado => {
                    const option = document.createElement('option');
                    option.value = grado;
                    option.textContent = `Grado ${grado}`;
                    gradoSelect.appendChild(option);
                });
                gradoSelect.disabled = false;
                resetearSelects([componenteSelect, competenciaSelect]);
            });

            // 3. Al cambiar Grado -> Filtra Componentes
            gradoSelect.addEventListener('change', () => {
                const areaSel = areaSelect.value;
                const gradoSel = gradoSelect.value;
                const componentes = [...new Set(mallasData
                    .filter(item => item.area === areaSel && item.grado == gradoSel)
                    .map(item => item.componente))];

                componenteSelect.innerHTML = '<option value="" disabled selected>Seleccione un componente</option>';
                componentes.sort().forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    componenteSelect.appendChild(option);
                });
                componenteSelect.disabled = false;
                resetearSelects([competenciaSelect]);
            });

            // 4. Al cambiar Componente -> Filtra Competencias
            componenteSelect.addEventListener('change', () => {
                const areaSel = areaSelect.value;
                const gradoSel = gradoSelect.value;
                const compSel = componenteSelect.value;
                const competencias = [...new Set(mallasData
                    .filter(item => item.area === areaSel && item.grado == gradoSel && item.componente === compSel)
                    .map(item => item.competencia))];

                competenciaSelect.innerHTML = '<option value="" disabled selected>Seleccione una competencia</option>';
                competencias.sort().forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    competenciaSelect.appendChild(option);
                });
                competenciaSelect.disabled = false;
            });

            // 5. Botón Consultar
            btnConsultar.addEventListener('click', () => {
                const fArea = areaSelect.value;
                const fGrado = gradoSelect.value;
                const fComp = componenteSelect.value;
                const fCompe = competenciaSelect.value;

                if (!fArea || !fGrado) {
                    alert("Por favor seleccione al menos Área y Grado");
                    return;
                }

                const filtrados = mallasData.filter(item => 
                    item.area === fArea &&
                    item.grado == fGrado &&
                    (!fComp || item.componente === fComp) &&
                    (!fCompe || item.competencia === fCompe)
                );

                mostrarResultados(filtrados);
            });

            function mostrarResultados(items) {
                resultadoCuerpo.innerHTML = '';
                if (items.length === 0) {
                    resultadoCuerpo.innerHTML = '<tr><td colspan="4" class="text-center">No hay datos para esta selección</td></tr>';
                } else {
                    items.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${item.aprendizaje || 'N/A'}</td>
                            <td>${item.evidencia || 'N/A'}</td>
                            <td>${item.estandar || 'N/A'}</td>
                            <td>${item.db || 'N/A'}</td>
                        `;
                        resultadoCuerpo.appendChild(tr);
                    });
                }
                resultadosDiv.classList.remove('d-none');
                resultadosDiv.scrollIntoView({ behavior: 'smooth' });
            }

            function resetearSelects(selects) {
                selects.forEach(s => {
                    s.innerHTML = `<option value="" disabled selected>Seleccione ${s.id}</option>`;
                    s.disabled = true;
                });
            }
        });
    </script>
</body>
</html>
